






<!doctype html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="author" content="Micro Ming">
  
  
  
  
    <meta name="description" content="0x01：👏搭建项目自动化部署">
  
  <title>Docker+Gitlab+Jenkins自动化管理项目 [ Micro Log ]</title>
  
  
    <link rel="shortcut icon" href="/hollow.ico">
  
  
  
<link rel="stylesheet" href="/css/random.css">
<link rel="stylesheet" href="/css/vegas.min.css">
<link rel="stylesheet" href="/css/highlight-railscasts.css">
<link rel="stylesheet" href="/css/jquery.fancybox.css">
<link rel="stylesheet" href="/css/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css">
<link rel="stylesheet" href="/css/plyr.css">

  
<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>
<div class="side-navigate hide-area">
  
    <div class="item prev">
      <a href="/2020/01/07/java-nei-sheng-ji-zhi/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        Java内省机制
      </div>
    </div>
  
  
</div>
<div id="outer-container" class="hide-area">
<div id="container">
  <div id="menu-outer" class="slide-down">
    <div id="menu-inner">
      <div id="brand">
        
        <a onClick="openUserCard()">
          <img id="avatar" src="https://avatars2.githubusercontent.com/u/2735087?s=60&u=775d4033139cae6b23c593bcf59fa433224ba4e3&v=4"/>
          <div id="homelink">Micro Log</div>
        </a>
      </div>
      <div id="menu-list">
        <ul>
        
        
          
            <li>
          
            <a href="/index.html">Home</a>
            
          </li>
        
          
            <li>
          
            <a href="/archives">Archives</a>
            
          </li>
        
          
            <li>
          
            <a href="/tags">Tags</a>
            
          </li>
        
          
            <li>
          
            <a href="/categories">Categories</a>
            
          </li>
        
          
            <li>
          
            <a href="/about">About</a>
            
          </li>
        
          
            <li>
          
            <a href="https://github.com/stiekel" target="_blank" rel="noopener">Github</a>
            
          </li>
        
        </ul>
      </div>
      <div id="show-menu">
        <button>Menu</button>
      </div>
    </div>
  </div>

  <div id="content-outer">
    <div id="content-inner">
      
      
  

  <article id="post">
    <h1>Docker+Gitlab+Jenkins自动化管理项目</h1>
    <p class="page-title-sub">
      <span id = "post-title-date">撰写于 2019-11-11</span>
      
        <span id = "post-title-updated">修改于 2020-03-22</span>
      
      
      
        <span id = "post-title-tags">
          标签
          
          
            
            
            <a href="/tags/Docker/">Docker</a>
          
            
              /
            
            
            <a href="/tags/Jenkins/">Jenkins</a>
          
        </span>
      
      <span id="/2019/11/11/dockergitlabjenkins/" class="leancloud-visitors" data-flag-title="Docker+Gitlab+Jenkins自动化管理项目">
        <i class="leancloud-visitors-count"></i>
        <em class="post-meta-item-text"> views </em>
      </span>
    </p>
    
    <p>0x01：👏搭建项目自动化部署</p>
<a id="more"></a>


<h3 id="一、环境配置："><a href="#一、环境配置：" class="headerlink" title="一、环境配置：**"></a>一、环境配置：**</h3><blockquote>
<ul>
<li><code>System</code>：CentOS 7</li>
<li><code>GitLab Version</code>：beginor/gitlab-ce:11.0.1-ce.0</li>
<li><code>JenKins Version</code>：官网最新 <a href="http://mirrors.jenkins.io/war-stable/latest/jenkins.war" target="_blank" rel="noopener">jenkins.war</a></li>
<li><code>JDK Version</code>: 1.8 </li>
<li><code>Maven Version</code>:  3.6.1 </li>
</ul>
</blockquote>
<h3 id="二、Dokcer"><a href="#二、Dokcer" class="headerlink" title="二、Dokcer:"></a>二、Dokcer:</h3><ol>
<li><h4 id="安装需要的库"><a href="#安装需要的库" class="headerlink" title="安装需要的库"></a><strong>安装需要的库</strong></h4><ul>
<li><pre class=" language-shell"><code class="language-shell">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</code></pre>
</li>
</ul>
</li>
<li><h4 id="添加docker的源"><a href="#添加docker的源" class="headerlink" title="添加docker的源"></a><strong>添加docker的源</strong></h4><ul>
<li><pre class=" language-shell"><code class="language-shell">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</code></pre>
</li>
</ul>
</li>
<li><h4 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a><strong>安装Docker</strong></h4><ul>
<li><pre class=" language-shell"><code class="language-shell">sudo yum install docker-ce</code></pre>
</li>
</ul>
</li>
<li><h4 id="启动docker服务和开机自启"><a href="#启动docker服务和开机自启" class="headerlink" title="启动docker服务和开机自启"></a><strong>启动docker服务和开机自启</strong></h4><ul>
<li><pre class=" language-shell"><code class="language-shell">sudo systemctl start docker
sudo systemctl enable docker</code></pre>
</li>
</ul>
</li>
<li><h4 id="Docker-Installed-End"><a href="#Docker-Installed-End" class="headerlink" title="Docker Installed End"></a><strong><code>Docker Installed End</code></strong></h4></li>
</ol>
<h3 id="三、Gitlab："><a href="#三、Gitlab：" class="headerlink" title="三、Gitlab："></a>三、Gitlab：</h3><ul>
<li><h4 id="PS："><a href="#PS：" class="headerlink" title="PS："></a>PS：</h4><ul>
<li>关闭防火墙：systemctl stop firewalld</li>
<li>关闭防火墙自启：systemctl disable firewalld</li>
</ul>
</li>
</ul>
<ol>
<li><h4 id="创建映射文件夹（可自定义，待会儿自己修改命令相关的参数）"><a href="#创建映射文件夹（可自定义，待会儿自己修改命令相关的参数）" class="headerlink" title="创建映射文件夹（可自定义，待会儿自己修改命令相关的参数）"></a><strong>创建映射文件夹</strong>（可自定义，待会儿自己修改命令相关的参数）</h4><ul>
<li><pre class=" language-shell"><code class="language-shell">mkdir -p /data/gitlab/etc
mkdir -p /data/gitlab/log
mkdir -p /data/gitlab/data</code></pre>
</li>
</ul>
</li>
<li><h4 id="安装并启动GitLab"><a href="#安装并启动GitLab" class="headerlink" title="安装并启动GitLab"></a><strong>安装并启动GitLab</strong></h4><ul>
<li><blockquote>
<h4 id="参数解析："><a href="#参数解析：" class="headerlink" title="参数解析："></a><strong><code>参数解析：</code></strong></h4></blockquote>
<pre class=" language-shell"><code class="language-shell">--detach 表示后台运行
--publish 表示容器类与宿机映射和端口
--name 表示容器的名字
--restart 重启策略：退出容器是重启容器</code></pre>
</li>
<li><blockquote>
<h4 id="构建容器命令"><a href="#构建容器命令" class="headerlink" title="构建容器命令"></a><code>构建容器命令</code></h4></blockquote>
<pre class=" language-shell"><code class="language-shell">docker run \
 --detach \
 --publish 998:22 \
 --publish 8443:443 \
 --publish 80:80 \
 --name gitlab \
 --restart unless-stopped \
 -v /data/gitlab/etc:/etc/gitlab \
 -v /data/gitlab/log:/var/log/gitlab \
 -v /data/gitlab/data:/var/opt/gitlab \
 beginor/gitlab-ce:11.0.1-ce.0</code></pre>
</li>
<li><blockquote>
<p><strong>在命令的最后的一行为镜像的名称(<code>beginor/gitlab-ce:11.0.1-ce.0</code>)或者ID(需要先<code>docker pull 镜像</code>，后通过 <code>docker images</code>，可以获取到镜像的ID)，运行上面的命令即可安装并启动gitlab（这样他会先检查本地有没有此镜像，没有就会先pull，然后再带参数run）。</strong></p>
</blockquote>
<pre class=" language-shell"><code class="language-shell">docker ps： 查看正在运行的容器
docker ps -a：查看所有创建的容器</code></pre>
</li>
</ul>
</li>
</ol>
<h3 id="四、Jenkins："><a href="#四、Jenkins：" class="headerlink" title="四、Jenkins："></a>四、Jenkins：</h3><ol>
<li><h4 id="下载相关的包"><a href="#下载相关的包" class="headerlink" title="下载相关的包:"></a><strong>下载相关的包</strong>:</h4><ul>
<li><code>Jenkins.war包（这儿是用java启动，你也可以通过docker）、maven、jdk</code></li>
</ul>
</li>
<li><h4 id="运行参数"><a href="#运行参数" class="headerlink" title="运行参数:"></a><strong>运行参数</strong>:</h4><ul>
<li><pre class=" language-shell"><code class="language-shell">java  -Djava.awt.headless=true -DJENKINS_HOME=/var/lib/jenkins -jar /usr/lib/jenkins/jenkins.war --logfile=/var/log/jenkins/jenkins.log --webroot=/var/cache/jenkins/war --httpPort=8088 --debug=5 --handlerCountMax=100 --handlerCountMaxIdle=20</code></pre>
</li>
<li><blockquote>
<p><code>参数解析：</code></p>
<pre class=" language-shell"><code class="language-shell">java  -Djava.awt.headless=true #解释：https://www.cnblogs.com/wudi-dudu/p/7871405.html
   -DJENKINS_HOME=/var/lib/jenkins #定义Jenkins的根目录
   -jar /usr/lib/jenkins/jenkins.war #war包位置，根据你的实际情况填写参数
   --logfile=/var/log/jenkins/jenkins.log #Jenkins的日志输出
   --webroot=/var/cache/jenkins/war #Jenkins缓存路径
   --httpPort=8088 #Jenkins的端口（看自己的端口情况修改）
   --debug=5 #
   --handlerCountMax=100 #
   --handlerCountMaxIdle=20 #</code></pre>
</blockquote>
</li>
</ul>
</li>
<li><h4 id="访问-http-ip-httpPort-即可开始Jenkins之旅"><a href="#访问-http-ip-httpPort-即可开始Jenkins之旅" class="headerlink" title="访问 http://ip:httpPort 即可开始Jenkins之旅:"></a><strong>访问 <a href="http://ip:httpPort">http://ip:httpPort</a> 即可开始<code>Jenkins</code>之旅</strong>:</h4><ul>
<li>首先去提示的路径复制密码到 Input 框;</li>
<li>然后选择推荐插件，这儿可能有点慢，看各自的网速;</li>
<li>安装完后即可创建账户;</li>
<li>Jenkins搭建结束。</li>
</ul>
</li>
</ol>
<h3 id="五、实现从Gitlab自动拉取代码并部署："><a href="#五、实现从Gitlab自动拉取代码并部署：" class="headerlink" title="五、实现从Gitlab自动拉取代码并部署："></a>五、实现从Gitlab自动拉取代码并部署：</h3><ol>
<li><h4 id="登录界面"><a href="#登录界面" class="headerlink" title="登录界面"></a><strong>登录界面</strong></h4><p><a href="https://imgchr.com/i/KrPuwD" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/10/26/KrPuwD.md.png" alt="KrPuwD.md.png"></a></p>
</li>
<li><h4 id="登录后的界面（新的没有任何的任务）"><a href="#登录后的界面（新的没有任何的任务）" class="headerlink" title="登录后的界面（新的没有任何的任务）"></a><strong>登录后的界面</strong>（新的没有任何的任务）</h4><p><img src="https://s2.ax1x.com/2019/10/26/KrP20U.png" alt="KrP20U.png"></p>
</li>
<li><h4 id="新建工作空间"><a href="#新建工作空间" class="headerlink" title="新建工作空间"></a><strong>新建工作空间</strong></h4><ol>
<li><p><strong>创建任务</strong><img src="https://s2.ax1x.com/2019/10/27/KriOK0.png" alt="KriOK0.png"></p>
</li>
<li><p><strong>通用配置</strong></p>
<ol>
<li><p>这儿配置两个参数：第一个参数 <strong>Discard old builds</strong> <img src="https://s2.ax1x.com/2019/10/27/KretoV.png" alt="KretoV.png"></p>
</li>
<li><p><strong>第二个参数 This project is  parameterized</strong> </p>
</li>
</ol>
<p><img src="https://s2.ax1x.com/2019/10/27/KrlguF.png" alt="KrlguF.png"> </p>
</li>
<li><p><strong>源码管理</strong>（我们用gitlab，这儿需要自己现在Gitlab中去创建项目和获取项目地址）<img src="https://s2.ax1x.com/2019/10/27/KrtNRA.png" alt="KrtNRA.png"></p>
</li>
<li><p><strong>构建触发器</strong>（构建方式有好多种，具体看实际情况，日程表可以直接copy）</p>
<p><img src="https://s2.ax1x.com/2019/10/27/KrtWMq.png" alt="KrtWMq.png"></p>
<p><code>可参考SCDN</code>：【<a href="https://blog.csdn.net/xueyingqi/article/details/53216506" target="_blank" rel="noopener">Poll SCM</a>】</p>
</li>
<li><p><strong>构建环境</strong>：不用设置，跳过</p>
</li>
<li><p><strong>构建</strong>：因为启动项目的方式有很多种方案，所以这儿可以使用骨灰级的方式（shell）</p>
<ul>
<li><p>ps：<strong>本次演示的是在搭建的Jenkins的服务器中，启动项目，如果你需要将项目到第三方服务器是上启动，就得在第三方服务器的路径下写启动脚本（start.sh）,这是一种解决方案，但不是绝对的。</strong></p>
</li>
<li><p>添加构建方式： <code>Execute shell</code></p>
</li>
<li><pre class=" language-shell"><code class="language-shell">#$：这儿是在引用刚刚在 This project is  parameterized 配置的参数
case $test_dev in
   deploy)
   #当选择的是 deploy 就执行下面呢的命令,注意绝对路径
     /usr/local/maven/bin/mvn clean package --settings /usr/local/maven/conf/settings.xml -Dmaven.test.skip=true
     ;;
   rollback)
   #当选择的是这个即是回滚
        echo "${version}"
     rm -rf target
     #${JENKINS_HOME}此参数是Jenkins默认的俄路径，自己和自己的核对改成对应的路径
     cp -R ${JENKINS_HOME}/jobs/你的任务名/builds/${version}/archive/target .
     pwd && ls
     ;;
   *)
     exit
     ;;
esac
jenkinsjarpath=${JENKINS_HOME}/workspace/你的任务名 #如test_dev
jarpath=/data/test/target #这是你要启动项目的路径（将jar包复制到此目录）
cp ${jenkinsjarpath}/target/test.jar /data/test/ #将jar包复制到jarpath
sh /data/test/start.sh ${port} #执行jarpath的shell脚本（类容为启动jar包的命令）
echo "Start Run......"</code></pre>
</li>
<li><p>start.sh</p>
<pre class=" language-shell"><code class="language-shell">#!/bash/bin
jarName=test.jar
function shutDown(){
        #获取上一次的构建的项目pid
        pid=`ps -ef|grep ${jarName}|grep -v grep|awk '{print $2}'`
             kill -9 ${pid} #干掉
             echo "shut down" #打印信息
}

function startUp(){
        #2:是打印错误到屏幕，&: 打印到后台
        nohup java -jar test.jar --server.port=$1  >> ./logs.log 2>&1 & #$1是运用上面参数${port}
        echo "start up"
}
#先关闭上一个项目
shutDown()
#启动新构建的项目
startUp()</code></pre>
</li>
</ul>
</li>
<li><p><strong>构建后操作</strong></p>
<p><img src="https://s2.ax1x.com/2019/10/27/KrwuBq.png" alt="KrwuBq.png"></p>
</li>
</ol>
</li>
<li><p>回到开始：</p>
<p><img src="https://s2.ax1x.com/2019/10/27/KrwCHP.png" alt="KrwCHP.png"></p>
</li>
<li><p><strong>现在你可以是实现自动Gitlab+jenkins 构建项目了。</strong></p>
</li>
<li><p><strong>Shell 脚本方面可以参考下</strong> 【<a href="https://www.runoob.com/linux/linux-shell.html" target="_blank" rel="noopener">菜鸟教程</a>】</p>
</li>
</ol>

  </article>
  <div class="random-toc-area">
  <button class="btn-hide-toc btn-hide-toc-show" style="display: none" onclick="TOCToggle()">显示目录</button>
  <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">隐藏目录</button>
  <div class="random-toc">
    <h2>目录</h2>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、环境配置："><span class="toc-text">一、环境配置：**</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、Dokcer"><span class="toc-text">二、Dokcer:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装需要的库"><span class="toc-text">安装需要的库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加docker的源"><span class="toc-text">添加docker的源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装Docker"><span class="toc-text">安装Docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动docker服务和开机自启"><span class="toc-text">启动docker服务和开机自启</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-Installed-End"><span class="toc-text">Docker Installed End</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、Gitlab："><span class="toc-text">三、Gitlab：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PS："><span class="toc-text">PS：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建映射文件夹（可自定义，待会儿自己修改命令相关的参数）"><span class="toc-text">创建映射文件夹（可自定义，待会儿自己修改命令相关的参数）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装并启动GitLab"><span class="toc-text">安装并启动GitLab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#参数解析："><span class="toc-text">参数解析：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建容器命令"><span class="toc-text">构建容器命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、Jenkins："><span class="toc-text">四、Jenkins：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载相关的包"><span class="toc-text">下载相关的包:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行参数"><span class="toc-text">运行参数:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#访问-http-ip-httpPort-即可开始Jenkins之旅"><span class="toc-text">访问 http:&#x2F;&#x2F;ip:httpPort 即可开始Jenkins之旅:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#五、实现从Gitlab自动拉取代码并部署："><span class="toc-text">五、实现从Gitlab自动拉取代码并部署：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#登录界面"><span class="toc-text">登录界面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#登录后的界面（新的没有任何的任务）"><span class="toc-text">登录后的界面（新的没有任何的任务）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#新建工作空间"><span class="toc-text">新建工作空间</span></a></li></ol></li></ol>
  </div>
</div>

  
  
<nav id="pagination">
  
    <a href="/2020/01/07/java-nei-sheng-ji-zhi/" class="prev">&larr; 上一篇 Java内省机制</a>
  

  

  
</nav>

  <!-- JiaThis Button BEGIN -->

<!-- JiaThis Button END -->


      
      
    </div>
  </div>

  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Micro Ming using
      <a href="http://hexo.io" target="_blank" rel="noopener">Hexo</a> & <a href="https://github.com/stiekel/hexo-theme-random" target="_blank" rel="noopener">Random</a>
      <br>
      
    </div>
  </div>
</div>

</div>


<div id="user-card">
  <div class="center-field">
    <img class="avatar" src="https://avatars2.githubusercontent.com/u/2735087?s=60&u=775d4033139cae6b23c593bcf59fa433224ba4e3&v=4">
    <p id="description"></p>
    <ul class="social-icon">
  
  
    <li>
      <a href="https://github.com/stiekel" target="_blank" rel="noopener">
        
          <i class="icon iconfont github">&#xe606;</i>
        
      </a>
    </li>
  
    <li>
      <a href="http://weibo.com/sidcn" target="_blank" rel="noopener">
        
          <i class="icon iconfont weibo">&#xe602;</i>
        
      </a>
    </li>
  
    <li>
      <a href="histkc@gmail.com">
        
          M
        
      </a>
    </li>
  
</ul>
  </div>
</div>


<div id="btn-view">Hide</div>

<script>
// is trigger analytics / tongji script
var isIgnoreHost = false;

if(window && window.location && window.location.host) {
  isIgnoreHost = ["localhost","127.0.0.1"].some(function(address){
    return 0 === window.location.host.indexOf(address);
  });
}

var isTriggerAnalytics = !( true && isIgnoreHost );

</script>




  
  
    <script src="/js/jquery-2.2.3.min.js"></script>
  
    <script src="/js/vegas.min.js"></script>
  
    <script src="/js/random.js"></script>
  
    <script src="/js/highlight.pack.js"></script>
  
    <script src="/js/jquery.mousewheel.pack.js"></script>
  
    <script src="/js/jquery.fancybox.pack.js"></script>
  
    <script src="/js/jquery.fancybox-thumbs.js"></script>
  
    <script src="/js/plyr.js"></script>
  

<script>

  // fancybox
  var backgroundImages = [];
  
  $('#post').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox') || $(this).parent().hasClass('fancybox-thumb')) return;
      var alt = this.alt || this.title;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'post' + i);
    });
  });
  $(".fancybox").fancybox();

var vegasConfig = {"preload­Image":true,"transition":["flash"],"timer":true,"delay":1500000,"shuffle":true,"count":12};
var unsplashConfig = {"gravity":"center"};
// is show background images
var turnoffBackgroundImage = false;




var backgroundColor = "34495E";

$(".fancybox-thumb").fancybox({
  prevEffect: 'none',
  nextEffect: 'none',
  helpers: {
    title: {
      type: 'outside'
    },
    thumbs: {
      width: 50,
      height: 50
    }
  }
});

// show video with plyr
$(".video-container iframe").each(function(i){
  var url = $(this).attr('src');
  var id = url.split('/').pop();
  var plyrContainer = document.createElement('div');
  plyrContainer.className = 'plyr';
  var plyrElement = document.createElement('div');
  plyrElement.dataset.videoId = id;
  switch(true) {
    case url.search('youtube.com') >= 0:
      plyrElement.dataset.type = 'youtube';
      break;
    case url.search('vimeo.com') >= 0:
      plyrElement.dataset.type = 'vimeo';
      break;
    default:
      return;
  };
  plyrContainer.appendChild(plyrElement);
  $(this).parent().html(plyrContainer);
});
plyr.setup('.plyr', {iconUrl: '/css/sprite.svg'});
</script>
</body>
</html>

